# Telegram Finance Bot

## Назначение

Личный Telegram-бот для ручного учёта доходов и расходов.

Бот предназначен **для одного пользователя** и используется как простой, быстрый инструмент фиксации финансовых операций и получения аналитических отчётов прямо в Telegram.

Основные задачи:
- быстро записывать доходы и расходы;
- сохранять контекст операций (категория + комментарий);
- получать понятную статистику и аналитику за разные периоды.

---

## Общие принципы работы

1. Бот работает в режиме **long polling** (без webhook).
2. Запускается как отдельный Node.js‑процесс на сервере.
3. Домен, HTTPS и веб‑маршруты не требуются.
4. Бот обрабатывает сообщения **только от одного Telegram‑пользователя** (проверка по `telegramId`).
5. Все данные хранятся в PostgreSQL.

---

## Типы операций

Поддерживаются два типа операций:

- **INCOME** — доход
- **EXPENSE** — расход

Каждая операция содержит:
- тип (доход / расход);
- категорию;
- сумму;
- комментарий (опционально);
- дату и время создания.

---

## Категории

### Категории доходов

Базовый набор:
- Работа
- Подарки
- Другое

Категория выбирается из кнопок. Детализация выполняется через комментарий.

### Категории расходов

Базовый набор:
- Еда
- Проезд
- Одежда
- Кино
- Покупки
- Переводы
- Другое

Категории фиксированы на старте, но архитектура допускает расширение.

---

## Пользовательские сценарии

### Добавление дохода

Последовательность:
1. Запуск команды `/income` или кнопка «Доход»
2. Ввод суммы
3. Выбор категории дохода
4. Ввод комментария (или `-`)
5. Сохранение операции

---

### Добавление расхода

Последовательность:
1. Запуск команды `/expense` или кнопка «Расход»
2. Ввод суммы
3. Выбор категории расхода
4. Ввод комментария (или `-`)
5. Сохранение операции

---

### Общая статистика

Команда: `/stats`

Возможные периоды:
- сегодня
- последние 7 дней
- текущий месяц
- произвольный период

Отображаемые показатели:
- общий доход;
- общий расход;
- баланс;
- средние доходы и расходы в день.

---

### Статистика по категории

Отчёт по выбранной категории за выбранный период:
- суммарная сумма;
- среднее значение в день;
- количество операций.

Пример: «Сколько потрачено на еду за месяц».

---

### Рейтинг расходов

Команда: `/rating`

Функционал:
- выбор периода;
- агрегация расходов по категориям;
- сортировка по убыванию суммы.

Отображается список категорий от самой затратной к наименее затратной.

---

## Стек технологий

### Платформа

- **Node.js** (LTS)
- **NestJS**

Используется для:
- модульной архитектуры;
- dependency injection;
- чёткого разделения логики по доменам.

---

### Telegram интеграция

- **Telegraf**
- **nestjs-telegraf**

Используется для:
- обработки команд и сообщений;
- работы с кнопками и inline‑клавиатурами;
- поддержки long polling (без webhook).

---

### База данных

- **PostgreSQL**

Используется для:
- хранения пользователей;
- хранения операций;
- выполнения агрегатных запросов для отчётов.

---

### ORM и миграции

- **TypeORM**

Используется для:
- описания сущностей;
- работы с репозиториями;
- управления схемой БД;
- выполнения миграций.

Миграции применяются при деплое и изменении структуры данных.

---

### Конфигурация

- `@nestjs/config`
- `.env` файлы

Хранение:
- токена Telegram‑бота;
- параметров подключения к БД;
- `ALLOWED_TELEGRAM_USER_ID`.

---

### Дополнительно

- `class-validator`, `class-transformer` — валидация и DTO
- встроенный логгер NestJS

---

## Ограничения

- бот не интегрирован с банковскими API;
- все операции вводятся вручную;
- бот не предназначен для массового использования;
- масштабирование и high‑availability не являются целями проекта.

---

## Направления для дальнейшего развития

- добавление пользовательских категорий;
- экспорт данных (CSV / Excel);
- статистика за произвольные интервалы с графиками;
- переход на webhook при необходимости;
- поддержка нескольких пользователей.


---

# Архитектура приложения

## 1. Структура уровней

Приложение разделено на три логических слоя:

### 1.1. Интерфейс (Telegram)
- Обрабатывает команды, сообщения и нажатия кнопок.
- Работает через Telegraf и интеграцию `nestjs-telegraf`.
- Не содержит бизнес-логики, только вызывает доменные сервисы.

### 1.2. Домен (бизнес-логика)
- Сервисы и модули: `User`, `Category`, `Operation`, `Report`.
- Вся логика добавления операций, подсчёта статистики, формирования отчётов.

### 1.3. Инфраструктура
- PostgreSQL + TypeORM.
- Конфигурация (`@nestjs/config`).
- Миграции.

---

## 2. Структура проекта (директории)

```text
src/
  main.ts
  app.module.ts

  config/
    configuration.ts
    validation.ts

  database/
    database.module.ts
    migrations/

  common/
    enums/
    types/
    utils/

  modules/
    user/
      user.module.ts
      user.entity.ts
      user.service.ts
    category/
      category.module.ts
      category.entity.ts
      category.service.ts
    operation/
      operation.module.ts
      operation.entity.ts
      operation.service.ts
      dto/
    report/
      report.module.ts
      report.service.ts
      dto/
    telegram/
      telegram.module.ts
      telegram.update.ts
      telegram.service.ts
      keyboards/
      state/
```

---

## 3. Описание модулей

### 3.1. AppModule
- Импортирует все остальные модули.
- Не содержит логики.

### 3.2. ConfigModule
- `@nestjs/config`.
- Загружает `.env`.
- Используется модулями TypeORM и Telegram.

### 3.3. DatabaseModule
- Настраивает подключение к PostgreSQL.
- Регистрирует сущности TypeORM.
- Поддерживает миграции.

### 3.4. UserModule
**UserEntity:**
- `id`
- `telegramId`
- `username`, `firstName`, `lastName`
- `createdAt`

**UserService:**
- `findOrCreateByTelegramId`
- `getByTelegramId`

### 3.5. CategoryModule
**CategoryEntity:**
- `id`
- `type` — INCOME / EXPENSE
- `code` — уникальный строковый идентификатор
- `displayName`
- `order`

**CategoryService:**
- `getCategoriesByType`
- `getByCode`
- инициализация дефолтных категорий

### 3.6. OperationModule
**OperationEntity:**
- `id`
- `user` (ManyToOne)
- `type`
- `category` (ManyToOne)
- `amount`
- `comment`
- `createdAt`

**OperationService:**
- `createOperation`
- `getOperationsByPeriod`
- `getLastOperations`

### 3.7. ReportModule
**ReportService:**
- `getSummary(user, period)`
- `getCategoryStats(user, category, period)`
- `getExpenseRating(user, period)`
- `resolvePeriod(type, customDates?)`

### 3.8. TelegramModule

**telegram.update.ts:**
- `/start`
- `/income`
- `/expense`
- `/stats`
- `/rating`
- `/last`
- обработка callback-кнопок

**telegram.service.ts:**
- вспомогательные функции форматирования ответов

**keyboards/:**
- клавиатуры для категорий, меню, выбора периода

**state/dialog-state.service.ts:**
- хранение состояния диалога
- `Map<userId, DialogState>`

---

## 4. Потоки данных

### 4.1. Добавление дохода `/income`
1. Пользователь вызывает `/income`.
2. `DialogStateService` переводит диалог в `income_amount`.
3. Ввод суммы.
4. Выбор категории.
5. Ввод комментария.
6. `OperationService.createOperation`.
7. Очистка состояния.

### 4.2. Добавление расхода `/expense`
Аналогично, но категории другие.

### 4.3. `/stats`
1. Выбор периода.
2. Вычисления через `ReportService.getSummary`.
3. Форматирование ответа.

### 4.4. `/rating`
1. Выбор периода.
2. `ReportService.getExpenseRating`.
3. Форматирование ответа.

### 4.5. `/last`
1. `OperationService.getLastOperations`.
2. Форматирование результата.

---

## 5. Расширяемость

- Возможность вынести состояния в Redis.
- Пользовательские категории.
- Экспорт данных.
- Перевод на webhook.
- Графики, расширенные отчёты.

---

## 6. Итог

Архитектура опирается на NestJS-модули, разделённые по доменным областям:
- Telegram — только интерфейс;
- Operation/Category/Report — доменная логика;
- PostgreSQL + TypeORM — хранение данных.

Структура позволяет легко расширять функциональность и сохраняет изоляцию между слоями.